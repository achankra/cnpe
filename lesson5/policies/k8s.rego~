package cnpe.compliance

default allow := false

# Collect all violations
violations[msg] {
  input.kind == "Deployment"
  not input.metadata.labels.team
  msg := "missing label: metadata.labels.team"
}

violations[msg] {
  input.kind == "Deployment"
  not input.metadata.labels.environment
  msg := "missing label: metadata.labels.environment"
}

violations[msg] {
  c := input.spec.template.spec.containers[_]
  endswith(c.image, ":latest")
  msg := sprintf("image tag must not be latest: %s", [c.image])
}

violations[msg] {
  c := input.spec.template.spec.containers[_]
  not c.resources.requests.cpu
  msg := sprintf("missing cpu request for container: %s", [c.name])
}

violations[msg] {
  c := input.spec.template.spec.containers[_]
  not c.resources.requests.memory
  msg := sprintf("missing memory request for container: %s", [c.name])
}

violations[msg] {
  c := input.spec.template.spec.containers[_]
  not c.resources.limits.cpu
  msg := sprintf("missing cpu limit for container: %s", [c.name])
}

violations[msg] {
  c := input.spec.template.spec.containers[_]
  not c.resources.limits.memory
  msg := sprintf("missing memory limit for container: %s", [c.name])
}

violations[msg] {
  sc := input.spec.template.spec.securityContext
  # treat missing securityContext as non-compliant
  not sc
  msg := "missing pod securityContext (runAsNonRoot required)"
}

violations[msg] {
  sc := input.spec.template.spec.securityContext
  sc.runAsNonRoot != true
  msg := "pod must set securityContext.runAsNonRoot=true"
}

# allow only if there are no violations
allow {
  count(violations) == 0
}
